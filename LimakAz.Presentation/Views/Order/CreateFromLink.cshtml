@model OrderCreateDto
@inject ICookieService _cookiesService
@inject ICurrencyService _currencyService;
<!-- Middle Sections -->
<div>
    <!-- Middle Section -->
    <div class="middlecontainer">
        <!-- Order Plans -->
        <div class="order-main-pg">
            <div class="row order-card-main-row">
                <div class="col-lg-9 col-12">
                    <div>
                        <div id="exTab2" class="container">
                            <ul class="nav nav-tabs">
                                <li class="nav-tabs-head-list ">
                                    <img src="https://limak.az/new_front/assets/img/dashboard/icons/tr-circle.svg" alt="">
                                    <a class="tabs-head" onclick="setCountryId(4)">Türkiyə</a>
                                </li>
                                <li class="nav-tabs-head-list">
                                    <img src="https://limak.az/new_front/assets/img/dashboard/icons/usa-circle.svg" alt="">
                                    <a class="tabs-head" onclick="setCountryId(5)">Amerika</a>
                                </li>
                            </ul>
                            <div class="tab-content ">

                                <!-- TURKEY ORDER LIST -->
                                <div class="tab-pane d-flex" id="1">
                                    <form asp-controller="order" asp-action="create" method="post" class="tr-form d-flex">
                                        <input type="hidden" asp-for="CountryId" />
                                        <div asp-validation-summary="ModelOnly"></div>
                                        <div class="ordercard-list tukish active">
                                            <div class="order-card-body order-turkish active">
                                                <div class="form-ordercard">
                                                    <div class="row">
                                                        <div class="col-sm-9 col-12">
                                                            <div>
                                                                <label class="form-control-label" for="product-link">Məhsulun linki *</label>
                                                                <div class="url-input-block">
                                                                    <input asp-for="Link" placeholder="Məhsulun linki"
                                                                           required="required" class="form-control-url">
                                                                    <span asp-validation-for="Link" class="danger"></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-3 col-12">
                                                            <div id="product-price">
                                                                <label for="product-price" class="form-control-label-custom">Məbləğ * </label>
                                                                <div>
                                                                    <div class="input-price-group">
                                                                        <input asp-for="ItemPrice" id="itemPrice" class="price-input product-priceTr" type="number" min="1" required="required">
                                                                        <div class="input-group-append">
                                                                            <div class="input-group-price-curency currency-label">TRY</div>
                                                                        </div>
                                                                        <span asp-validation-for="ItemPrice" class="danger"></span>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        @* <div class="col-sm-6 col-12">
                                                            <div class="check-group-label">
                                                                <label class="form-control-label-custom" for="check-label-head">Türkiyə içi kargo</label>
                                                                <div class="input-radio-group">
                                                                    <div class="check-custom check-custom-radio">
                                                                        <input asp-for="IsLocalCargoFree" type="radio" id="check-kargo-radio" value="true" name="some-radios" class="custom-control-input">
                                                                        <label class="radio-label" for="check-kargo-radio">Bəli</label>
                                                                    </div>
                                                                    <div class="check-custom check-custom-radio">
                                                                        <input asp-for="IsLocalCargoFree" type="radio" id="check-kargo-radio-not" value="false" name="some-radios" checked class="custom-control-input">
                                                                        <label class="radio-label" for="check-kargo-radio-not">Xeyr</label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
 *@
                                                        <div class="col-sm-4 col-12">
                                                            <div id="product-kargo-price" class="kargo-daxil-price">
                                                                <label class="form-control-label-custom" for="product-kargo-price">Karqo məbləği *</label>
                                                                <div>
                                                                    <div class="input-price-group">
                                                                        <input asp-for="LocalCargoPrice" id="localCargoPrice" class="price-input" placeholder="0"
                                                                               id="olke-daxili-kargo" type="number"
                                                                               min="1" required="required">
                                                                        <div class="input-group-append">
                                                                            <div class="input-group-price-curency currency-label">TRY</div>
                                                                        </div>
                                                                        <span asp-validation-for="LocalCargoPrice" class="danger"></span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-4 col-12">
                                                            <div id="product-kargo-price" class="kargo-daxil-price">
                                                                <label class="form-control-label-custom" for="product-kargo-price">
                                                                    <span id="percentage-label">(+5%)</span>
                                                                </label>
                                                                <div>
                                                                    <div class="input-price-group">
                                                                        <input asp-for="OrderTotalPrice" id="orderTotalPrice" class="price-input product-price-percentTr" placeholder="0"
                                                                               type="number"
                                                                               min="1" required="required" disabled>
                                                                        <div class="input-group-append">
                                                                            <div class="input-group-price-curency currency-label">TRY</div>
                                                                        </div>
                                                                        <span asp-validation-for="OrderTotalPrice" class="danger"></span>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-4 col-12">
                                                            <div id="product-count" class="product-count-block">
                                                                <label for="product-count"
                                                                       class="form-control-label-custom">Say</label>
                                                                <div class="product-count-input-body">
                                                                    <input asp-for="Count" id="count" type="number" min="1"
                                                                           placeholder="Say"
                                                                           value="1"
                                                                           class="product-count-input">
                                                                    <span asp-validation-for="Count" class="danger"></span>

                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-4 col-12">
                                                            <div id="product-count" class="product-count-block">
                                                                <label for="product-count"
                                                                       class="form-control-label-custom">Məhsulun rəngi *</label>
                                                                <div class="product-count-input-body">
                                                                    <input asp-for="Color" type="text"
                                                                           placeholder="Məhsulun rəngi"
                                                                           class="product-count-input">
                                                                    <span asp-validation-for="Color" class="danger"></span>

                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-4 col-12">
                                                            <div id="product-count" class="product-count-block">
                                                                <label for="product-count"
                                                                       class="form-control-label-custom">Məhsulun ölçüsü *</label>
                                                                <div class="product-count-input-body">
                                                                    <input asp-for="Size" type="text"
                                                                           placeholder="Məhsulun ölçüsü"
                                                                           class="product-count-input">
                                                                    <span asp-validation-for="Size" class="danger"></span>

                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <div id="product-desc">
                                                                <label class="form-control-label-custom"
                                                                       for="product-desc">Qeydlər</label>
                                                                <div>
                                                                    <input asp-for="Notes" type="text"
                                                                           placeholder="Ölçü, rəng və s. üçün qeydlər"
                                                                           required="required"
                                                                           class="desc-control-input">
                                                                    <span asp-validation-for="Notes" class="danger"></span>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="order-card-actions">
                                                        <div></div>
                                                        <div>
                                                            <button type="submit" @(!_cookiesService.IsAuthorized() ? "disabled" : "") class="link-button" style="width:170px">
                                                                <img src="https://limak.az/new_front/assets/img/icons/plus-circle.svg" alt="">
                                                                <span>Sebete elave et</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        @if (_cookiesService.IsAuthorized())
                                        {

                                            <div class="col-lg-3 col-12">
                                                <div class="tab-content right-bar-payment">
                                                    <div class="sidebar" style="margin-top:60px">
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <div class="ordercard-payment">
                                                                    <div class="payment-total" style="font-size:20px">
                                                                        <span>Cəmi:</span>
                                                                        <strong class="payment-total-price">0</strong> AZN
                                                                    </div>

                                                                    <select asp-for="LocalPointId" class="sidebar-depo-select" style="width:100%">
                                                                        @foreach (var item in Model.LocalPoints)
                                                                        {
                                                                            if (item.Id == Model.SelectedLocalPointId)
                                                                            {
                                                                                <option value="@item.Id" selected>
                                                                                    @item.LocalPointDetails.FirstOrDefault()?.Name
                                                                                </option>
                                                                            }
                                                                            else
                                                                            {
                                                                                <option value="@item.Id">
                                                                                    @item.LocalPointDetails.FirstOrDefault()?.Name
                                                                                </option>
                                                                            }
                                                                        }
                                                                    </select>
                                                                    @* <button type="button" disabled="disabled"
                                                                            class="payment-btn">
                                                                        ÖDƏNİŞ ET
                                                                    </button> *@
                                                                    <div class="payment">
                                                                        @* <span class="desc">və ya səbətə gedin</span> *@
                                                                        <div class="badgeBtn-body">
                                                                            <a asp-controller="basket" asp-action="index" target="_self" class="badgetBtn ">
                                                                                <div class="d-flex align-items-center gap-2 justify-content-center">
                                                                                    SƏBƏTƏ GET
                                                                                </div>
                                                                            </a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </form>
                                </div>

                            </div>
                            <div class="extraTabContent"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>


<script>
    let selectedCountryId = null;

    function setCountryId(countryId) {
        // Set the CountryId value in the form
        document.getElementById("CountryId").value = countryId;


        selectedCountryId = countryId;
        console.log("countryId ftom set methid" + countryId)
        console.log("countryId ftom set methid" + selectedCountryId)
        // Get the elements for currency and percentage labels
        var currencyLabels = document.querySelectorAll('.currency-label');
        var percentageLabel = document.getElementById("percentage-label");

        // Update the active tab styling
        var tabListItems = document.querySelectorAll('.nav-tabs-head-list');
        tabListItems.forEach(function(item) {
            item.classList.remove('active');
        });

        // Change currency and percentage based on the selected country
        if (countryId === 4) {
            // For Turkey (TR), set TRY and +5%
            tabListItems[0].classList.add('active');

            // Update all currency labels to TRY
            currencyLabels.forEach(function(label) {
                label.textContent = "TRY";
            });

            // Update percentage label
            percentageLabel.textContent = "(+5%)";
        } else if (countryId === 5) {
            // For USA (USD), set USD and +7%
            tabListItems[1].classList.add('active');

            // Update all currency labels to USD
            currencyLabels.forEach(function(label) {
                label.textContent = "USD";
            });

            // Update percentage label
            percentageLabel.textContent = "(+7%)";
        }
    }
    // console.log("countryId outside methid" + selectedCountryId)

        document.addEventListener('DOMContentLoaded', function () {
        const itemPriceInput = document.getElementById('itemPrice');
        const localCargoPriceInput = document.getElementById('localCargoPrice');
        const countInput = document.getElementById('count');
        const orderTotalPriceOutput = document.getElementById('orderTotalPrice');
        const totalPriceElement = document.querySelector('.payment-total-price');

        console.log("countryId in price method methid" + selectedCountryId)
        // Function to calculate the total price
        async function calculateTotalPrice() {
            const itemPrice = parseFloat(itemPriceInput.value) || 0; // Default to 0 if not a valid number
            const localCargoPrice = parseFloat(localCargoPriceInput.value) || 0; // Default to 0 if not a valid number
            const count = parseInt(countInput.value) || 1; // Default to 1 if not a valid number

            var orderTotalPrice = 0;
            // Calculate the order total price
            console.log(selectedCountryId)
            if(selectedCountryId == 5){
            orderTotalPrice = (itemPrice * count + localCargoPrice) * 1.07;
            }
            else{
            orderTotalPrice = (itemPrice * count + localCargoPrice) * 1.05;

            }

            // Display the calculated total price
            orderTotalPriceOutput.value = orderTotalPrice.toFixed(2); // Format to 2 decimal places

            var totalPriceInAzn = 0;

            if(selectedCountryId == 5){
                totalPriceInAzn = await convertCurrency(orderTotalPrice, "USD", "AZN");
            }
            else{
                totalPriceInAzn = await convertCurrency(orderTotalPrice, "TRY", "AZN");

            }

             totalPriceElement.textContent = orderTotalPrice.toFixed(2);
             totalPriceElement.textContent = totalPriceInAzn.toFixed(2);


              async function convertCurrency(amount, fromCurrency, toCurrency) {
            try {
                const response = await fetch(`/currency/convert?amount=${amount}&from=${fromCurrency}&to=${toCurrency}`);

                if (!response.ok) {
                    console.error("Error fetching conversion data:", response.statusText);
                    return 0;
                }

                const data = await response.json();
                return data.convertedAmount;
            } catch (error) {
                console.error("Error during conversion:", error);
                return 0;
            }
        }
        }

        // Event listeners for input changes to recalculate the total price
        itemPriceInput.addEventListener('input', calculateTotalPrice);
        localCargoPriceInput.addEventListener('input', calculateTotalPrice);
        countInput.addEventListener('input', calculateTotalPrice);

        // Initial calculation (in case there are default values)
        calculateTotalPrice();
    });

</script>

<style>
    button[disabled] {
        background-color: #ccc; /* Disabled button color */
        cursor: not-allowed; /* Change cursor to indicate disabled state */
    }

    .input-price-group {
        justify-content: start;
    }
</style>