@model OrderItemCreateDto
@inject ICookieService _cookiesService
@inject ICurrencyService _currencyService;
@inject OrderLocalizer _localizer;
<!-- Middle Sections -->
<div>
    <!-- Middle Section -->
    <div class="middlecontainer">
        <!-- Order Plans -->
        <div class="order-main-pg">
            <div class="row order-card-main-row">
                <div class="col-lg-9 col-12">
                    <div>
                        <div id="exTab2" class="container">
                            <ul class="nav nav-tabs">
                                <li class="nav-tabs-head-list" style="cursor:pointer">
                                    <img src="https://limak.az/new_front/assets/img/dashboard/icons/tr-circle.svg" alt="">
                                    <a class="tabs-head" onclick="setCountryId(1)">@_localizer.GetValue("turkey")</a>
                                </li>
                                <li class="nav-tabs-head-list" style="cursor:pointer">
                                    <img src="https://limak.az/new_front/assets/img/dashboard/icons/usa-circle.svg" alt="">
                                    <a class="tabs-head" onclick="setCountryId(2)">@_localizer.GetValue("america")</a>
                                </li>
                            </ul>
                            <div class="tab-content ">

                                <!-- TURKEY ORDER LIST -->
                                <div class="tab-pane d-flex" id="1">
                                    <form asp-controller="order" asp-action="create" method="post" class="tr-form d-flex">
                                        <input type="hidden" asp-for="CountryId" />
                                        <div class="ordercard-list tukish active">
                                            <div class="order-card-body order-turkish active">
                                                <div asp-validation-summary="ModelOnly"></div>
                                                <div class="form-ordercard">
                                                    <div class="row">
                                                        <div class="col-sm-9 col-12">
                                                            <div>
                                                                <label class="form-control-label" for="product-link">@_localizer.GetValue("link")*</label>
                                                                <div class="url-input-block">
                                                                    <input asp-for="Link" placeholder="@_localizer.GetValue("link")"
                                                                           required="required" class="form-control-url">
                                                                    <span asp-validation-for="Link" class="danger"></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-3 col-12">
                                                            <div id="product-price">
                                                                <label for="product-price" class="form-control-label-custom">@_localizer.GetValue("price") * </label>
                                                                <div>
                                                                    <div class="input-price-group">
                                                                        <input asp-for="ItemPrice" id="itemPrice" class="price-input product-priceTr" type="number" min="1" required="required">
                                                                        <div class="input-group-append">
                                                                            <div class="input-group-price-curency currency-label">TRY</div>
                                                                        </div>
                                                                        <span asp-validation-for="ItemPrice" class="danger"></span>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
 
                                                        <div class="col-sm-4 col-12">
                                                            <div id="product-kargo-price" class="kargo-daxil-price">
                                                                <label class="form-control-label-custom" for="product-kargo-price">@_localizer.GetValue("cargoPrice") *</label>
                                                                <div>
                                                                    <div class="input-price-group">
                                                                        <input asp-for="LocalCargoPrice" id="localCargoPrice" class="price-input" placeholder="0"
                                                                               id="olke-daxili-kargo" type="number"
                                                                               min="0" required="required">
                                                                        <div class="input-group-append">
                                                                            <div class="input-group-price-curency currency-label">TRY</div>
                                                                        </div>
                                                                        <span asp-validation-for="LocalCargoPrice" class="danger"></span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-4 col-12">
                                                            <div id="product-kargo-price" class="kargo-daxil-price">
                                                                <label class="form-control-label-custom" for="product-kargo-price">
                                                                    <span id="percentage-label">(+5%)</span>
                                                                </label>
                                                                <div>
                                                                    <div class="input-price-group">
                                                                        <input asp-for="OrderItemTotalPrice" id="orderTotalPrice" class="price-input product-price-percentTr" placeholder="0"
                                                                               type="number"
                                                                               min="1" required="required" disabled>
                                                                        <div class="input-group-append">
                                                                            <div class="input-group-price-curency currency-label">TRY</div>
                                                                        </div>
                                                                        <span asp-validation-for="OrderItemTotalPrice" class="danger"></span>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-4 col-12">
                                                            <div id="product-count" class="product-count-block">
                                                                <label for="product-count"
                                                                       class="form-control-label-custom">@_localizer.GetValue("count")</label>
                                                                <div class="product-count-input-body">
                                                                    <input asp-for="Count" id="count" type="number" min="1"
                                                                           placeholder="@_localizer.GetValue("count")"
                                                                           value="1"
                                                                           class="product-count-input">
                                                                    <span asp-validation-for="Count" class="danger"></span>

                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-4 col-12">
                                                            <div id="product-count" class="product-count-block">
                                                                <label for="product-count"
                                                                       class="form-control-label-custom">@_localizer.GetValue("color") *</label>
                                                                <div class="product-count-input-body">
                                                                    <input asp-for="Color" type="text"
                                                                           placeholder="@_localizer.GetValue("color")"
                                                                           class="product-count-input">
                                                                    <span asp-validation-for="Color" class="danger"></span>

                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-4 col-12">
                                                            <div id="product-count" class="product-count-block">
                                                                <label for="product-count"
                                                                       class="form-control-label-custom">@_localizer.GetValue("size") *</label>
                                                                <div class="product-count-input-body">
                                                                    <input asp-for="Size" type="text"
                                                                           placeholder="@_localizer.GetValue("size")"
                                                                           class="product-count-input">
                                                                    <span asp-validation-for="Size" class="danger"></span>

                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <div id="product-desc">
                                                                <label class="form-control-label-custom"
                                                                       for="product-desc">@_localizer.GetValue("notes")</label>
                                                                <div>
                                                                    <input asp-for="Notes" type="text"
                                                                           placeholder="@_localizer.GetValue("additionalNotes")"
                                                                           required="required"
                                                                           class="desc-control-input">
                                                                    <span asp-validation-for="Notes" class="danger"></span>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="order-card-actions">
                                                        <div></div>
                                                        <div>
                                                            <button type="submit" @(!_cookiesService.IsAuthorized() ? "disabled" : "") class="btn btn-success" style="width:170px" >
                                                                <img src="https://limak.az/new_front/assets/img/icons/plus-circle.svg" alt="">
                                                                <span>@_localizer.GetValue("addToBasket")</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        @if (_cookiesService.IsAuthorized())
                                        {

                                            <div class="col-lg-3 col-12">
                                                <div class="tab-content right-bar-payment">
                                                    <div class="sidebar" style="margin-top:60px">
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <div class="ordercard-payment">
                                                                    <div class="payment-total" style="font-size:20px">
                                                                        <span>@_localizer.GetValue("sum"):</span>
                                                                        <strong class="payment-total-price">0</strong> AZN
                                                                    </div>

                                                                    
                                                                    <div class="payment">
                                                                        @* <span class="desc">və ya səbətə gedin</span> *@
                                                                        <div class="badgeBtn-body">
                                                                            <a asp-controller="basket" asp-action="index" target="_self" class="badgetBtn ">
                                                                                <div class="d-flex align-items-center gap-2 justify-content-center">
                                                                                    @_localizer.GetValue("goToBasket")
                                                                                </div>
                                                                            </a>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </form>
                                </div>

                            </div>
                            <div class="extraTabContent"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>


<script>
    let selectedCountryId = 1;

    function setCountryId(countryId) {
        document.getElementById("CountryId").value = countryId;


        selectedCountryId = countryId;
        console.log("countryId ftom set methid" + countryId)
        console.log("countryId ftom set methid" + selectedCountryId)
       
        var currencyLabels = document.querySelectorAll('.currency-label');
        var percentageLabel = document.getElementById("percentage-label");

        var tabListItems = document.querySelectorAll('.nav-tabs-head-list');
        tabListItems.forEach(function(item) {
            item.classList.remove('active');
        });

        if (countryId === 1) {
            tabListItems[0].classList.add('active');

            currencyLabels.forEach(function(label) {
                label.textContent = "TRY";
            });

            percentageLabel.textContent = "(+5%)";
        } else if (countryId === 2) {
            tabListItems[1].classList.add('active');

            currencyLabels.forEach(function(label) {
                label.textContent = "USD";
            });

            percentageLabel.textContent = "(+7%)";
        }
    }

        document.addEventListener('DOMContentLoaded', function () {
        const itemPriceInput = document.getElementById('itemPrice');
        const localCargoPriceInput = document.getElementById('localCargoPrice');
        const countInput = document.getElementById('count');
        const orderTotalPriceOutput = document.getElementById('orderTotalPrice');
        const totalPriceElement = document.querySelector('.payment-total-price');

        console.log("countryId in price method methid" + selectedCountryId)
        // Function to calculate the total price
        async function calculateTotalPrice() {
            const itemPrice = parseFloat(itemPriceInput.value) || 0; 
            const localCargoPrice = parseFloat(localCargoPriceInput.value) || 0; 
            const count = parseInt(countInput.value) || 1; 

            var orderTotalPrice = 0;
            // Calculate the order total price
            console.log(selectedCountryId)
            if(selectedCountryId == 2){
            orderTotalPrice = (itemPrice * count + localCargoPrice) * 1.07;
            }
            else{
            orderTotalPrice = (itemPrice * count + localCargoPrice) * 1.05;

            }

            // Display the calculated total price
            orderTotalPriceOutput.value = orderTotalPrice.toFixed(2); // Format to 2 decimal places

            var totalPriceInAzn = 0;

            if(selectedCountryId == 2){
                totalPriceInAzn = await convertCurrency(orderTotalPrice, "USD", "AZN");
            }
            else{
                totalPriceInAzn = await convertCurrency(orderTotalPrice, "TRY", "AZN");

            }

             totalPriceElement.textContent = orderTotalPrice.toFixed(2);
             totalPriceElement.textContent = totalPriceInAzn.toFixed(2);


              async function convertCurrency(amount, fromCurrency, toCurrency) {
            try {
                const response = await fetch(`/currency/convert?amount=${amount}&from=${fromCurrency}&to=${toCurrency}`);

                if (!response.ok) {
                    console.error("Error fetching conversion data:", response.statusText);
                    return 0;
                }

                const data = await response.json();
                return data.convertedAmount;
            } catch (error) {
                console.error("Error during conversion:", error);
                return 0;
            }
        }
        }

        itemPriceInput.addEventListener('input', calculateTotalPrice);
        localCargoPriceInput.addEventListener('input', calculateTotalPrice);
        countInput.addEventListener('input', calculateTotalPrice);

        calculateTotalPrice();
    });

</script>

<style>
    button {
        background-color: #3e8e41
    }

        button :active {
        background-color: #3e8e41;
        box-shadow: 0 5px #666;
        transform: translateY(4px);
    }
    button[disabled] {
        background-color: #ccc; 
        cursor: not-allowed;
    }

    .input-price-group {
        justify-content: start;
    }
</style>